#!/usr/bin/env bash
#
# Main executable shell script.

readonly CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# shellcheck source=/dev/null
source "${CURRENT_DIR}/packages/packages.sh"

# shellcheck source=/dev/null
source "${CURRENT_DIR}/config.sh"

# shellcheck source=/dev/null
source "${CURRENT_DIR}/functions.sh"

# shellcheck source=/dev/null
source "${CURRENT_DIR}/commands.sh"

#######################################
# Main shell script.
#
# Globals:
#   SONARQUBE_DASHBOARD_URL
#   WHITE
#   NC
#
# Arguments:
#   User input
#
# Outputs:
#   Writes message to stdout.
#
# Returns:
#   0 if SonarQube Docker Container is running.
#   1 if SonarQube Docker Container is not running or invalid user input.
#######################################
function main() {
  if [ $# == 0 ]; then
    if ! is_sonarqube_docker_containers_running; then
      output "SonarQube is running on ${WHITE}${SONARQUBE_DASHBOARD_URL}${NC}."

      exit 0
    else
      output "${WHITE}SonarQube is not running.${NC}"
      output "Use the following commands: ${WHITE}sonarqube up${NC}."

      exit 1
    fi
  fi

  # loop through user input.
  for arg in "$@"; do
    shift
    case "$arg" in
      dashboard)
        command::dashboard
        break;;
      down)
        command::down
        break;;
      publish)
        command::publish "$1"
        break;;
      scan)
        command::scan
        break;;
      up)
        command::up
        break;;
      *)
        output "Command ${WHITE}${arg}${NC} not supported."
        exit 1;;
    esac
  done
}

# Verify operating system is supported...
is_operating_system_supported

# Ensure that Docker is running...
is_docker_running

# Execute main function...
main "$@"
